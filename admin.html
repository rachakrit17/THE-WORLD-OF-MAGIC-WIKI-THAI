
<!doctype html><html lang="th"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>หลังบ้าน — THE‑WORLD‑OF‑MAGIC‑WIKI‑THAI</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="assets/css/styles.css">
</head>
<body class="bg-dark text-light">
<div id="topnav"></div>
<main class="container my-4">
  <!-- Login Gate -->
  <section id="loginGate" class="row justify-content-center">
    <div class="col-md-8 col-lg-6">
      <div class="neon p-4 text-center rounded-2xl">
        <h1 class="h4 mb-2">🛡️ เข้าหลังบ้าน</h1>
        <p class="opacity-70 mb-3">เข้าสู่ระบบด้วย Google ก่อน จึงจะใช้งานหลังบ้านได้</p>
        <button id="btnGoogle" class="btn btn-neon btn-lg">🔑 Sign in with Google</button>
        <div id="loginError" class="small text-danger mt-3 d-none"></div>
      </div>
    </div>
  </section>

  <!-- Admin Panel -->
  <section id="adminPanel" class="d-none">
    <div class="d-flex align-items-center justify-content-between mb-3">
      <div>
        <h1 class="h4 mb-1">🛠️ หลังบ้าน <span class="badge badge-soft ms-2">Deluxe</span></h1>
        <div class="small opacity-70">คลิกเมนูซ้ายเพื่อแก้ไขข้อมูล • มีตัวอย่างฟิลด์รูปแบบ URL</div>
      </div>
      <div class="d-flex align-items-center gap-2">
        <div class="badge bg-success d-none" id="roleBadge">admin</div>
        <button id="btnSignout" class="btn btn-outline-light btn-sm">ออกจากระบบ</button>
      </div>
    </div>

    <div class="row g-3">
      <div class="col-lg-3 admin-aside">
        <div class="list-group sticky-top-md" id="adminMenu"></div>
        <div id="statsBox" class="neon p-3 mt-3 small rounded-2xl"></div>
      </div>
      <div class="col-lg-9">
        <div class="card neon rounded-2xl">
          <div class="card-body">
            <h2 id="adminTitle" class="h5 mb-3">Guides</h2>
            <form id="adminForm" class="row g-3"></form>
            <div class="d-flex flex-wrap gap-2 mt-2">
              <button class="btn btn-neon" id="btnSave">บันทึก (Draft) 💾</button>
              <button class="btn btn-success" id="btnPublish" type="button">บันทึก & เผยแพร่ 🚀</button>
              <button class="btn btn-secondary" id="btnNew" type="button">ใหม่ 🆕</button>
              <button class="btn btn-danger" id="btnDelete" type="button">ลบ 🗑️</button>
            </div>
            <hr>
            <div class="table-responsive">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <div class="input-group w-auto">
                  <span class="input-group-text bg-dark text-light border-secondary">🔎</span>
                  <input id="gridSearch" class="form-control bg-dark text-light border-secondary" placeholder="ค้นหารายการในตาราง">
                </div>
                <span class="small opacity-70" id="gridCount"></span>
              </div>
              <table class="table table-dark table-striped align-middle">
                <thead id="gridHead"></thead>
                <tbody id="gridBody"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>
</main>
<div id="footer"></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/i18next@23.11.5/dist/umd/i18next.min.js"></script>
<script src="assets/js/i18n.js"></script>
<script src="assets/js/firebase-init.js"></script>
<script src="assets/js/auth.js"></script>
<script src="assets/js/fx.js"></script>
<script src="assets/js/app.js"></script>
<script src="assets/js/admin.js"></script>
<script>
  window.renderShell && window.renderShell();

  // Gate: show login if not authenticated or not admin
  const loginGate = document.getElementById('loginGate');
  const adminPanel = document.getElementById('adminPanel');
  const roleBadge = document.getElementById('roleBadge');
  const loginError = document.getElementById('loginError');

  function showLogin(msg){
    loginGate.classList.remove('d-none');
    adminPanel.classList.add('d-none');
    if(msg){ loginError.textContent = msg; loginError.classList.remove('d-none'); }
  }
  function showAdmin(){
    loginGate.classList.add('d-none');
    adminPanel.classList.remove('d-none');
    roleBadge.classList.remove('d-none');
    if(window.initAdminUI){ window.initAdminUI(); } // initialize admin UI once
  }

  // Sign in/out handlers (popup -> redirect fallback)
  document.getElementById('btnGoogle').addEventListener('click', async ()=>{
    const provider = new firebase.auth.GoogleAuthProvider();
    try{ await auth.signInWithPopup(provider); }
    catch(err){
      if(['auth/popup-blocked','auth/operation-not-supported-in-this-environment','auth/cancelled-popup-request'].includes(err?.code)){
        try{ await auth.signInWithRedirect(provider); }catch(e2){ showLogin(e2.message || 'Sign-in failed'); }
      }else{ showLogin(err.message || 'Sign-in failed'); }
    }
  });
  document.getElementById('btnSignout').addEventListener('click', async ()=>{ await auth.signOut(); });

  let initialized = false;
  auth.onAuthStateChanged(async (user)=>{
    if(!user){ showLogin(); return; }
    try{
      const r = await db.collection('roles').doc(user.uid).get();
      if(r.exists && r.data().role === 'admin'){ if(!initialized){ showAdmin(); initialized=true; } }
      else{ showLogin('บัญชีนี้ยังไม่ได้รับสิทธิ์ admin'); }
    }catch(e){ showLogin('ตรวจสอบสิทธิ์ไม่สำเร็จ'); }
  });
</script>
</body></html>
